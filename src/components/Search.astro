---
---

<div id="search" class="relative">
  <button
    id="search-btn"
    type="button"
    class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors"
    aria-label="Search"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>
  </button>
</div>

<!-- Search Modal -->
<div id="search-modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="search-backdrop"></div>
  <div class="relative max-w-2xl mx-auto mt-20 px-4">
    <div class="bg-[var(--bg-primary)] rounded-xl shadow-2xl border border-[var(--border-color)] overflow-hidden">
      <div id="pagefind-container"></div>
    </div>
  </div>
</div>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet" />
<style>
  :root {
    --pagefind-ui-scale: 0.9;
    --pagefind-ui-primary: var(--color-primary);
    --pagefind-ui-text: var(--text-primary);
    --pagefind-ui-background: var(--bg-primary);
    --pagefind-ui-border: var(--border-color);
    --pagefind-ui-tag: var(--bg-tertiary);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 8px;
    --pagefind-ui-font: inherit;
  }
</style>

<script is:inline>
  function initSearch() {
    const searchBtn = document.getElementById('search-btn');
    const searchModal = document.getElementById('search-modal');
    const searchBackdrop = document.getElementById('search-backdrop');
    const pagefindContainer = document.getElementById('pagefind-container');

    if (!searchBtn || !searchModal || !searchBackdrop || !pagefindContainer) return;

    let pagefindLoaded = false;

    async function openSearch() {
      searchModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      if (!pagefindLoaded) {
        try {
          const { PagefindUI } = await import('/pagefind/pagefind-ui.js');
          new PagefindUI({
            element: '#pagefind-container',
            showSubResults: true,
            showImages: false,
          });
          pagefindLoaded = true;
        } catch (e) {
          pagefindContainer.innerHTML = '<p class="p-4 text-[var(--text-muted)]">Search is available after building the site.</p>';
        }
      }

      setTimeout(() => {
        const input = pagefindContainer.querySelector('input');
        if (input) input.focus();
      }, 100);
    }

    function closeSearch() {
      searchModal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    searchBtn.addEventListener('click', openSearch);
    searchBackdrop.addEventListener('click', closeSearch);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        if (searchModal.classList.contains('hidden')) {
          openSearch();
        } else {
          closeSearch();
        }
      }
      if (e.key === 'Escape' && !searchModal.classList.contains('hidden')) {
        closeSearch();
      }
    });
  }

  initSearch();
  document.addEventListener('astro:after-swap', initSearch);
</script>
